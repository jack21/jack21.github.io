import{o as f,c as N,a as C,d as Z,u as W,r as F,k as R,h as ae,b as e,w as t,l as U,g as H,t as L,m as Fe,n as oe,q as ze,s as Me,p as M,v as Ve,y as Ee,x as de,z as me,i as Ue,e as m,F as ee,f as E,A as te,B as we,C as Pe,I as De,D as Ae,Q as Re,E as He,G as pe,H as _e,O as fe,J as he,K as ve,L as ge,Y as Oe,M as le,N as je,P as be,T as Ie,R as ye,S as Ze,j as Ne,V as We}from"./index-cMTOR0Iq.js";import{_ as Se}from"./download-1I4Z6k6F.js";import{P as Y}from"./papaparse.min-j-GbZ1Dd.js";import{_ as qe}from"./delete-outline-YrDiUvQp.js";import{i as Je,b as Qe}from"./index-8Bi13PKl.js";const Ye={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Ke=C("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),Xe=[Ke];function et(V,n){return f(),N("svg",Ye,[...Xe])}const Le={name:"mdi-close",render:et},tt={class:"export-sms-file"},st=C("span",null,"門號 (商務簡訊)",-1),nt={key:0,class:"ms-4 mt-2"},ot={class:"d-flex mt-2 align-items-center w-100"},lt={key:0,class:"hint"},at=Z({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(V){const n=V,l=W(),c=F(!1),v=F([]),b=F([]),S=F(0),k=F(0),G=F(new Set),h=F([]),i=F(!1),u={text:"匯入 91 優惠券",value:"upload-file"},r=R(()=>{const o=Array.from(l.userArgSet).map(s=>({text:s,value:s}));return o.push(u),o}),p=R(()=>v.value.findIndex(o=>o===u.value)>=0);ae(b,()=>{S.value=b.value.length,b.value.forEach(o=>g(o))});const g=o=>{i.value=!0,Y.parse(o,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(s,I)=>(console.log(`Header: ${I}`,s),s==="領取券號"?"couponCode":s==="是否領取"?"isRedeem":s),complete:s=>{if(s.errors.length>0){alert("Parse Error"),i.value=!1;return}const I=h.value.length;s.data.forEach($=>{if($.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${$.couponCode} -> ${$.isRedeem}`);return}if(G.value.has($.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${$.couponCode}`);return}G.value.add($.couponCode),h.value.push($.couponCode)});const z=h.value.length;console.log(`[ExportSmsFile] read ${s.data.length} -> ${z-I} coupon Code`),S.value--,k.value++,i.value=!1}})},y=R(()=>S.value>0),B=()=>{c.value=!0},a=async()=>{i.value=!0;const o=d(),s="export-sms-file-"+l.hashCode(l.campaignName);l.saveZip(o.fileName,o.downloadFileList,s),i.value=!1,c.value=!1},d=()=>{const o=[],s=oe(new Date,"yyyyMMdd");let I=0,z=0;const $=l.smsGroupList,O=[],j=[],D=[];for(let Q=0;Q<$.length;Q++){const T=$[Q];let J=0;const xe=[];console.log(`[ExportSmsFile] smsGroup: ${T.name}: ${T.smsSendInfoList.length}`);for(let X=0;X<T.smsSendInfoList.length;X++){const ue=T.smsSendInfoList[X];I++;const K=x(ue);z+=K.length,J+=K.length,console.log(`[ExportSmsFile] smsGroup: ${T.name}: [${X+1}] ${K.length}`),D.push(K.length);const re=l.partition(K,5e3);for(let se=0;se<re.length;se++){const ce=re[se],Ge=Y.unparse(ce,{delimiter:"	"}),Te=T.smsSendInfoList.length===1?"":`_${X+1}`,Be=re.length===1?"":`_${se+1}`,Ce=`${l.campaignName}_商務簡訊_${s}_${Q+1}${Te}${Be}_${T.name}_${ce.length}.txt`;o.push({fileName:Ce,data:Ge}),O.push({smsText:ue.text,phoneNumberFileName:Ce,smsCount:ce.length})}xe.push({smsText:ue.text,smsCount:K.length})}j.push({taName:T.name,smsCount:J,smsItemList:xe})}const P={};P.sendHour=ze.Hour20,P.sendMinute=Me.Minute00,P.smsList=O,P.smsGroupList=j;const A=`${l.campaignName}_商務簡訊_${s}_${$.length}受眾_${I}群_${z}.cfg`,q=JSON.stringify(P);o.push({fileName:A,data:q});const ie=`${l.campaignName}_商務簡訊_${s}_${$.length}受眾_${I}群_${z}.zip`;return console.log(`受眾表用
${D.join(`
`)}`),{fileName:ie,downloadFileList:o}},_=new Set(["0979940180","0937654385","0937573896","0970646973"]),x=o=>{const s=[],I=o.phoneNumberList;for(let z=0;z<I.length;z++){const $=I[z];if(_.has($))continue;const O=l.phoneNumberUserMap.get($);if(!O)continue;const j=[$];for(let D=0;D<r.value.length;D++){const P=r.value[D];if(v.value.findIndex(q=>q===P.value)>=0)if(P.value===u.value){const q=h.value[s.length];O.couponCode=q,j.push(q)}else O.params&&j.push(O.params[P.value])}s.push(j)}return s},w=()=>{b.value=[],k.value=0,h.value.length=0,G.value.clear()};return(o,s)=>{const I=Se,z=M,$=Ve,O=Ee,j=Le,D=de,P=me;return f(),N("div",tt,[e(z,{variant:"outline-primary",size:"sm",onClick:B,disabled:n.disabled},{default:t(()=>[e(I),st]),_:1},8,["disabled"]),e(P,{modelValue:c.value,"onUpdate:modelValue":s[2]||(s[2]=A=>c.value=A),"ok-title":"匯出","cancel-title":"取消","cancel-variant":"outline-secondary",title:"參數",class:"args-modal",busy:i.value,onOk:a,onCancel:s[3]||(s[3]=A=>c.value=!1),onClose:s[4]||(s[4]=A=>c.value=!1),onHide:s[5]||(s[5]=Fe(()=>{},["prevent"]))},{default:t(()=>[e($,{modelValue:v.value,"onUpdate:modelValue":s[0]||(s[0]=A=>v.value=A),options:r.value,stacked:""},null,8,["modelValue","options"]),p.value?(f(),N("div",nt,[C("div",ot,[e(O,{modelValue:b.value,"onUpdate:modelValue":s[1]||(s[1]=A=>b.value=A),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),G.value.size>0&&!y.value?(f(),U(z,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:w},{default:t(()=>[e(j)]),_:1})):H("",!0),y.value?(f(),U(D,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),k.value?(f(),N("small",lt,"已讀取 "+L(k.value)+" 檔案, "+L(G.value.size)+" 筆記錄",1)):H("",!0)])):H("",!0)]),_:1},8,["modelValue","busy"])])}}}),it={class:"export-sms-file"},ut=C("span",null,"門號 (客服)",-1),rt=Z({__name:"ExportCustomServiceFile",props:{disabled:{type:Boolean}},setup(V){const n=V,l=W(),c=()=>{const v=oe(new Date,"yyyyMMdd"),b=l.smsGroupList.filter(i=>i.smsPhoneNumberFilted.length>0),S=[];let k=0,G=0;for(let i=0;i<b.length;i++){const u=b[i];for(let r=0;r<u.smsSendInfoList.length;r++){G++;const p=u.smsSendInfoList[r],g=`用戶分群: ${u.name}\r
簡訊內容: ${p.text}\r
發送數量: ${p.phoneNumberList.length}\r
`,y=`${l.campaignName}_客服_${v}_${G}_發送資訊.txt`;S.push({fileName:y,data:g});const B=[];p.phoneNumberList.forEach(d=>B.push([d])),k+=p.phoneNumberList.length;const a=l.partition(B,5e4);for(let d=0;d<a.length;d++){const _=a[d],x=Y.unparse(_),w=a.length===1?"":`_${d+1}`,o=`${l.campaignName}_客服_${v}_${G}_門號${w}_${_.length}.txt`;S.push({fileName:o,data:x})}}}const h=`${l.campaignName}_客服_${v}_${G}群_${k}人.zip`;l.downloadZip(h,S)};return(v,b)=>{const S=Se,k=M;return f(),N("div",it,[e(k,{variant:"outline-primary",size:"sm",class:"mt-1",onClick:c,disabled:n.disabled},{default:t(()=>[e(S),ut]),_:1},8,["disabled"])])}}}),ct={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},dt=C("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),mt=[dt];function pt(V,n){return f(),N("svg",ct,[...mt])}const $e={name:"mdi-calculator",render:pt},_t={key:0,class:"sms-send"},ft=C("h6",{class:"title"},"分群測試",-1),ht={class:"section"},vt=C("h6",{class:"title"},"簡訊內容",-1),gt={class:"sms-item section"},bt={class:"sms-header"},St=["for"],Lt={class:"count"},$t={class:"sms-footer"},xt=Z({__name:"SmsSendModal",props:{smsGroup:{}},setup(V){const n=Ue(),l=W(),c=V,v=F(!1),b=F(1),S=F(["","",""]),k=p=>{const g=c.smsGroup.smsPhoneNumberFilted;if(g.length===0)return[];const y=Math.ceil(g.length/b.value);return l.partition(g,y)[p]},G=()=>{b.value=Math.max(c.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${b.value}`),S.value.length=0,c.smsGroup.smsSendInfoList.forEach(p=>{S.value.push(p.text)}),v.value=!0},h=()=>{if(!c.smsGroup)return;const p=S.value.splice(0,b.value);l.fillSmsSendInfo(c.smsGroup,p),n.setSmsText(c.smsGroup.name,p)},i=p=>p?p.length:0,u=p=>{const g=i(S.value[p]);return g===0?null:g<=70},r=(p,g)=>{if(g.phoneNumber){const y=l.sms(S.value[p],g.phoneNumber);console.log(`[SmsSend] URL: ${y}`),window.open(y,"_blank")}};return(p,g)=>{const y=M,B=Pe,a=De,d=Ae,_=Re,x=He,w=me;return c.smsGroup?(f(),N("div",_t,[e(y,{variant:"outline-primary",size:"sm",onClick:G,disabled:c.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[C("span",null,"編輯 ("+L(c.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(w,{modelValue:v.value,"onUpdate:modelValue":g[1]||(g[1]=o=>v.value=o),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:h,class:"sms-send-modal"},{default:t(()=>[C("section",null,[ft,C("div",ht,[e(a,{modelValue:b.value,"onUpdate:modelValue":g[0]||(g[0]=o=>b.value=o),name:"sms-test-group"},{default:t(()=>[e(B,{value:1},{default:t(()=>[m("不測試")]),_:1}),e(B,{value:2},{default:t(()=>[m("2 群")]),_:1}),e(B,{value:3},{default:t(()=>[m("3 群")]),_:1}),e(B,{value:4},{default:t(()=>[m("4 群")]),_:1}),e(B,{value:5},{default:t(()=>[m("5 群")]),_:1}),e(B,{value:6},{default:t(()=>[m("6 群")]),_:1})]),_:1},8,["modelValue"])])]),C("section",null,[vt,(f(!0),N(ee,null,te(b.value,o=>(f(),N("div",gt,[C("div",bt,[C("label",{for:`sms-text-${o}`},"簡訊 "+L(o),9,St),C("span",Lt,L(k(o-1).length)+" 人",1)]),e(d,{type:"text",size:"sm",id:`sms-text-${o}`,rows:"2",state:u(o-1),placeholder:"簡訊文案",modelValue:S.value[o-1],"onUpdate:modelValue":s=>S.value[o-1]=s},null,8,["id","state","modelValue","onUpdate:modelValue"]),C("div",$t,[e(x,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(f(!0),N(ee,null,te(E(l).userInfoListTest,s=>(f(),U(_,{onClick:I=>r(o-1,s),key:s.twmId},{default:t(()=>[m(L(s.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),C("span",{class:we(["sms-text",{warn:i(S.value[o-1])>70}])},L(i(S.value[o-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):H("",!0)}}}),Ct={key:0,class:"ta-group-list-modal number"},wt={key:0,class:""},It={class:"summary"},ne=100,ke=Z({__name:"TaGroupListModal",props:{twmIdList:{}},setup(V){const n=W(),l=V,c=F(!1),v=F(1),b=()=>{c.value=!0},S=R(()=>{const u=[];if(!c.value)return u;const r=(v.value-1)*ne;return G.value.slice(r,r+ne)}),k=u=>ne*(v.value-1)+u+1,G=R(()=>{const u=[];return c.value&&(console.time("[TaGroupListModal] allUserList"),l.twmIdList.forEach(r=>{const p=n.twmIdUserMap.get(r);p&&u.push(p)}),console.timeEnd("[TaGroupListModal] allUserList")),u}),h=R(()=>c.value?G.value.filter(u=>!!u.phoneNumber).length:0),i=R(()=>c.value?G.value.filter(u=>!!u.couponCode).length:0);return(u,r)=>{const p=M,g=pe,y=_e,B=fe,a=he,d=ve,_=ge,x=Oe,w=me;return l.twmIdList?(f(),N("div",Ct,[l.twmIdList.length===0?(f(),N("span",wt,"0")):(f(),U(p,{key:1,variant:"link",onClick:b,class:""},{default:t(()=>[m(L(l.twmIdList.length),1)]),_:1})),e(w,{modelValue:c.value,"onUpdate:modelValue":r[1]||(r[1]=o=>c.value=o),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[C("div",It,[m(" 總數："),C("span",null,L(l.twmIdList.length)+"，有門號："+L(h.value)+" (少 "+L(h.value-l.twmIdList.length)+")，有優惠券："+L(i.value)+" (少 "+L(i.value-l.twmIdList.length)+")",1)]),e(_,{hover:"",small:"",bordered:""},{default:t(()=>[e(B,null,{default:t(()=>[e(y,null,{default:t(()=>[e(g,{class:"text-center align-middle"},{default:t(()=>[m("No")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[m("台灣大會員編號")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[m("SubId")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[m("門號")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[m("資費")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[m("優惠券序號")]),_:1})]),_:1})]),_:1}),e(d,null,{default:t(()=>[(f(!0),N(ee,null,te(S.value,(o,s)=>(f(),U(y,{key:o.twmId},{default:t(()=>[e(a,{class:"text-center align-middle"},{default:t(()=>[m(L(k(s)),1)]),_:2},1024),e(a,{class:"text-center align-middle number"},{default:t(()=>[m(L(o.twmId),1)]),_:2},1024),e(a,{class:"text-center align-middle number"},{default:t(()=>[m(L(o.subId),1)]),_:2},1024),e(a,{class:"text-center align-middle number"},{default:t(()=>[m(L(o.phoneNumber),1)]),_:2},1024),e(a,{class:"text-center align-middle number"},{default:t(()=>[m(L(o.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(a,{class:"text-center align-middle number"},{default:t(()=>[m(L(o.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(x,{modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=o=>v.value=o),size:"sm","total-rows":l.twmIdList.length,"per-page":ne},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):H("",!0)}}}),yt={class:"calc-button"},Nt={key:1,class:"number"},kt=Z({__name:"CalcButton",setup(V){const n=W(),l=()=>{n.refresh()};return(c,v)=>{const b=$e,S=M,k=be;return f(),N("div",yt,[E(n).needReCalc?le((f(),U(S,{key:0,variant:"outline-success",size:"sm",onClick:l},{default:t(()=>[e(b)]),_:1})),[[k,"重新計算"]]):(f(),N("div",Nt,[je(c.$slots,"default")]))])}}}),Gt={class:"d-flex flex-column justify-content-end"},Tt=C("br",null,null,-1),Bt=C("span",{class:"hint"},"(商務簡訊)",-1),Ft={class:"text-nowrap"},zt={key:1},Mt={class:"text-nowrap"},Vt={class:"d-flex flex-column"},Et=C("span",null,"SubId (DSC)",-1),Ut={class:"d-flex flex-column"},Pt=C("span",null,"SubId (DSC)",-1),Dt=C("span",null,"名單總表",-1),is=Z({__name:"SmsGroupList",setup(V){const n=W(),l=F(!0),c=F(0),v=()=>{if(!n.smsGroupList)return l.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const a=new Set;for(let d=0;d<n.smsGroupList.length;d++){const x=n.smsGroupList[d].twmIdList;for(let w=0;w<x.length;w++){const o=x[w];a.add(o)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),l.value=!1,c.value=a.size},b=R(()=>{let a=0;return n.smsGroupList.forEach(d=>a+=d.smsTwmIdListFilted.length),a}),S=R(()=>{let a=0;return n.smsGroupList.forEach(d=>a+=d.smsPhoneNumberFilted.length),a}),k=(a,d)=>{const _=a.smsReadyTwmIdList;if(d>=100)a.smsTwmIdList=_.slice(0);else{const x=new Set;a.smsTwmIdList.forEach(s=>x.add(s));const w=_.length*d/100,o=h(_).slice(0,w);o.forEach(s=>x.add(s)),a.smsTwmIdList=Array.from(x),console.log(`[GroupList] addSmsList: ${w}: ${o.length}`)}n.refreshFilted()},G=a=>{for(let d=0;d<n.smsGroupList.length;d++){const _=n.smsGroupList[d];k(_,a)}},h=a=>{const d=a.slice(0);for(let _=d.length-1;_>0;_--){let x=Math.floor(Math.random()*(_+1));[d[_],d[x]]=[d[x],d[_]]}return d},i=a=>{const d=n.smsGroupList.findIndex(x=>x.name===a.name);d>=0&&n.smsGroupList.splice(d,1);const _=new Ie(a.name,a.twmIdList);n.groupList.push(_),n.refreshFilted(),l.value=!0},u=()=>{p(a=>a.twmIdList)},r=()=>{p(a=>a.smsTwmIdListFilted)},p=a=>{if(!n.smsGroupList)return;const d=[],_=new Set;for(let w=0;w<n.smsGroupList.length;w++){const o=n.smsGroupList[w],s=a(o);for(let I=0;I<s.length;I++){const z=s[I],$=n.twmIdUserMap.get(z);!$||!$.subId||$.phoneNumber&&$.phoneNumber.length>0||_.has($.subId)||(_.add($.subId),d.push({SUBSCR_ID:$.subId}))}}console.log(`[SmsGroupList] export ${d.length} subId`);const x=n.partition(d,2e5);for(let w=0;w<x.length;w++){const o=x[w],s=oe(new Date,"yyyyMMdd"),I=`${n.campaignName}_DSC_SubId_${s}_${x.length}-${w+1}_${o.length}.csv`,z=Y.unparse(o);n.downloadFile(z,I)}},g=()=>{if(!n.smsGroupList)return;const a=[];for(let w=0;w<n.smsGroupList.length;w++){const o=n.smsGroupList[w],s=o.smsPhoneNumberFilted;for(let I=0;I<s.length;I++){const z=s[I],$=n.phoneNumberUserMap.get(z);$&&a.push({Sms:o.name,TwmId:$.twmId,SubId:$.subId,門號:$.phoneNumber,優惠券:$.couponCode})}}console.log(`[SmsGroupList] export ${a.length} All Sms CSV`);const d=oe(new Date,"yyyyMMdd"),_=`${n.campaignName}_發送名單資訊_${d}_${a.length}.csv`,x=Y.unparse(a);n.downloadFile(x,_)},y=a=>a.smsReadyTwmIdList.length<=a.smsTwmIdList.length,B=()=>{for(let a=0;a<n.smsGroupList.length;a++){const d=n.smsGroupList[a];if(!y(d))return!1}return!0};return(a,d)=>{const _=pe,x=_e,w=fe,o=qe,s=he,I=kt,z=ke,$=xt,O=ve,j=$e,D=Se,P=rt,A=at,q=ye,ie=ge,Q=be;return f(),N("div",Gt,[e(ie,{hover:"",small:"",bordered:""},{default:t(()=>[e(w,{"head-variant":"dark"},{default:t(()=>[e(x,null,{default:t(()=>[e(_,{class:"text-center align-middle"},{default:t(()=>[m("刪除")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("分群")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("原數量")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("已發送數")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("可發送數")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("發送")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("欲發送數")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("發送數")]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("門號數"),Tt,Bt]),_:1}),e(_,{class:"text-center align-middle"},{default:t(()=>[m("簡訊內容")]),_:1})]),_:1})]),_:1}),e(O,null,{default:t(()=>[(f(!0),N(ee,null,te(E(n).smsGroupList,T=>(f(),U(x,{key:T.name},{default:t(()=>[e(s,{class:"text-center align-middle"},{default:t(()=>[e(E(M),{variant:"outline-danger",size:"sm",onClick:J=>i(T)},{default:t(()=>[e(o)]),_:2},1032,["onClick"])]),_:2},1024),e(_,{class:"align-middle"},{default:t(()=>[m(L(T.name),1)]),_:2},1024),e(s,{class:"text-end align-middle number"},{default:t(()=>{var J;return[m(L((J=T.twmIdList)==null?void 0:J.length),1)]}),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[m(L(T.sentCount),1)]),_:2},1024)]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[e(z,{"twm-id-list":T.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[C("div",Ft,[e(E(M),{variant:"outline-primary",size:"sm",onClick:J=>k(T,10),disabled:y(T)},{default:t(()=>[m("+10%")]),_:2},1032,["onClick","disabled"]),e(E(M),{variant:"outline-primary",size:"sm",onClick:J=>k(T,100),class:"ms-1",disabled:y(T)},{default:t(()=>[m("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e(z,{"twm-id-list":T.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[e(z,{"twm-id-list":T.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[m(L(T.smsPhoneNumberFilted.length),1)]),_:2},1024)]),_:2},1024),e(s,{class:"text-center align-middle"},{default:t(()=>[e($,{"sms-group":T},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(q,null,{default:t(()=>[e(x,null,{default:t(()=>[e(s),e(s,null,{default:t(()=>[m("共 "+L(E(n).smsGroupList.length)+" 群",1)]),_:1}),e(s,{class:we({"text-center":l.value,number:!l.value})},{default:t(()=>[l.value?le((f(),U(E(M),{key:0,variant:"outline-success",size:"sm",onClick:v},{default:t(()=>[e(j)]),_:1})),[[Q,"重新計算"]]):(f(),N("span",zt,L(c.value),1))]),_:1},8,["class"]),e(s),e(s),e(s,null,{default:t(()=>[C("div",Mt,[e(E(M),{variant:"outline-primary",size:"sm",onClick:d[0]||(d[0]=T=>G(10)),disabled:B()},{default:t(()=>[m("+10%")]),_:1},8,["disabled"]),e(E(M),{variant:"outline-primary",size:"sm",onClick:d[1]||(d[1]=T=>G(100)),class:"ms-1",disabled:B()},{default:t(()=>[m("All")]),_:1},8,["disabled"])])]),_:1}),e(s),e(s,{class:"text-center number"},{default:t(()=>[e(I,null,{default:t(()=>[m(L(b.value),1)]),_:1})]),_:1}),e(s,{class:"text-center number"},{default:t(()=>[e(I,null,{default:t(()=>[m(L(S.value),1)]),_:1})]),_:1}),e(s)]),_:1}),e(x,null,{default:t(()=>[e(s),e(s),e(s,{class:"text-center"},{default:t(()=>[C("div",Vt,[e(E(M),{variant:"outline-primary",size:"sm",onClick:u},{default:t(()=>[e(D),Et]),_:1})])]),_:1}),e(s),e(s),e(s),e(s),e(s,{class:"text-center"},{default:t(()=>[C("div",Ut,[le((f(),U(E(M),{variant:"outline-primary",size:"sm",onClick:r,disabled:b.value<=0},{default:t(()=>[e(D),Pt]),_:1},8,["disabled"])),[[Q,`匯出 ${b.value-S.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(s,{class:"text-center align-middle"}),e(s,{class:"text-center align-middle"},{default:t(()=>[e(P,{disabled:S.value<=0},null,8,["disabled"]),e(A,{class:"mt-1",disabled:S.value<=0},null,8,["disabled"])]),_:1})]),_:1}),e(x,null,{default:t(()=>[e(s),e(s),e(s),e(s),e(s),e(s),e(s),e(s,{colspan:"2",class:"text-center align-middle"},{default:t(()=>[e(E(M),{variant:"outline-primary",size:"sm",class:"mt-1",onClick:g,disabled:b.value<=0},{default:t(()=>[e(D),Dt]),_:1},8,["disabled"])]),_:1}),e(s)]),_:1})]),_:1})]),_:1})])}}}),At={key:1,class:"number"},us=Z({__name:"TaGroupList",setup(V){const n=W(),l=F(!0),c=F(0),v=R(()=>n.groupList?n.groupList.sort((h,i)=>h.name.localeCompare(i.name)):[]),b=()=>{if(!n.groupList)return l.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const h=new Set;for(let i=0;i<n.groupList.length;i++){const r=n.groupList[i].twmIdList;for(let p=0;p<r.length;p++){const g=r[p];h.add(g)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),c.value=h.size,l.value=!1},S=h=>{const i=n.groupList.findIndex(r=>r.name===h.name);i>=0&&n.groupList.splice(i,1),console.time("[TaGroupList] addSmsList");const u=new Ze(h.name,h.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),n.smsGroupList.push(u),n.refreshFilted()},k=()=>{[...n.groupList].forEach(i=>S(i))},G=async()=>{const[h]=await window.showOpenFilePicker({multiple:!1,types:[{accept:{"text/csv":[".csv"]}}]}),i=await h.getFile(),u=await i.text();Y.parse(u,{header:!1,skipEmptyLines:!0,complete:r=>{if(r.errors.length>0){alert("Parse Error");return}console.log(`[TaGroupList] add ${r.data.length} Users begin`);const p=[];for(let y=0;y<r.data.length;y++){const B=r.data[y],a=n.phoneNumberUserMap.get(B[2]);a&&p.push(a.twmId)}console.log(`[TaGroupList] add ${r.data.length} Users Complete`);const g=new Ie(i.name,p);n.groupList.push(g),console.log(`[TaGroupList] complete ${n.groupList.length} TaGroup`)}})};return(h,i)=>{const u=pe,r=_e,p=fe,g=ke,y=he,B=M,a=ve,d=$e,_=ye,x=ge,w=be;return f(),N("div",null,[e(x,{hover:"",small:"",bordered:""},{default:t(()=>[e(p,{"head-variant":"dark"},{default:t(()=>[e(r,null,{default:t(()=>[e(u,{class:"text-center align-middle"},{default:t(()=>[m("分群")]),_:1}),e(u,{class:"text-center align-middle"},{default:t(()=>[m("數量")]),_:1}),e(u,{class:"text-center align-middle"},{default:t(()=>[m("加入發送")]),_:1})]),_:1})]),_:1}),e(a,null,{default:t(()=>[(f(!0),N(ee,null,te(v.value,o=>(f(),U(r,{key:o.name},{default:t(()=>[e(u,{class:"align-middle"},{default:t(()=>[m(L(o.name),1)]),_:2},1024),e(y,{class:"text-center align-middle"},{default:t(()=>[e(g,{"twm-id-list":o.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e(u,{class:"text-center"},{default:t(()=>[e(B,{variant:"outline-primary",size:"sm",onClick:s=>S(o)},{default:t(()=>[m("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(_,null,{default:t(()=>[e(r,null,{default:t(()=>[e(y,null,{default:t(()=>[m("共 "+L(v.value.length)+" 群",1)]),_:1}),e(y,{class:"text-center"},{default:t(()=>[l.value?le((f(),U(B,{key:0,variant:"outline-success",size:"sm",onClick:b},{default:t(()=>[e(d)]),_:1})),[[w,"重新計算"]]):(f(),N("span",At,L(c.value),1))]),_:1}),e(y,{class:"text-center"},{default:t(()=>[e(B,{variant:"outline-primary",size:"sm",onClick:i[0]||(i[0]=o=>k())},{default:t(()=>[m("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(B,{variant:"outline-primary",size:"sm",onClick:G},{default:t(()=>[m("匯入 91App 受眾")]),_:1})])}}}),Rt={class:"sms-file-wrapper"},Ht=C("label",{for:"sms-file"},"已發送簡訊 (多選)",-1),Ot={class:"d-flex mt-2 align-items-center w-100"},jt={key:0,class:"hint"},rs=Z({__name:"ImportSmsSent",setup(V){const n=W(),l=F(0),c=F(0),v=F(0);ae(l,(h,i)=>{h===0&&i>0&&n.refreshFilted()});const b=R(()=>l.value>0),S=async()=>{const h=await window.showOpenFilePicker({id:"marketing-sms-sent-"+n.hashCode(n.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});l.value=h.length,h.forEach(async i=>{const r=await(await i.getFile()).text();k(r)})},k=h=>{const i=h==null?void 0:h.split(`
`),u=n.phoneNumberSentSet.size;v.value+=i.length,i.forEach(p=>{const y=p.split("	")[0];n.phoneNumberSentSet.add(y)});const r=n.phoneNumberSentSet.size;console.log(`[SmsFile] load ${r-u} Sent Phone Numbers, Total: ${n.phoneNumberSentSet.size}`),l.value--,c.value++},G=()=>{c.value=0,v.value=0,n.phoneNumberSentSet.clear(),n.refreshFilted()};return(h,i)=>{const u=M,r=Le,p=de;return f(),N("div",Rt,[Ht,C("div",Ot,[e(u,{variant:"outline-primary",size:"sm",onClick:S},{default:t(()=>[m("匯入")]),_:1}),v.value>0&&!b.value?(f(),U(u,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:G},{default:t(()=>[e(r)]),_:1})):H("",!0),b.value?(f(),U(p,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),c.value>0?(f(),N("small",jt,L(c.value)+" 檔案, "+L(v.value)+" 筆記錄, 重複 "+L(v.value-E(n).phoneNumberSentSet.size)+" 門號, "+L(E(n).phoneNumberSentSet.size)+" 門號",1)):H("",!0)])}}}),Zt={class:"import-dsc-wrapper"},Wt=C("label",{for:"dsc-file"},"門號 (DSC 轉出 csv)",-1),qt={class:"d-flex mt-2 align-items-center w-100"},Jt={key:0,class:"hint"},cs=Z({__name:"ImportDSC",setup(V){const n=W(),l=F(0),c=F(0),v=F(0);Ne(async()=>{}),ae(l,(i,u)=>{i===0&&u>0&&n.refreshFilted()});const b=R(()=>l.value>0),S=async()=>{const i=await window.showOpenFilePicker({id:"marketing-dsc",multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});l.value=i.length,i.forEach(async u=>{const p=await(await u.getFile()).arrayBuffer(),g=Je.decode(Qe.Buffer.from(p),"big5");k(g)})},k=i=>{Y.parse(i,{header:!0,skipEmptyLines:!0,transformHeader:(u,r)=>(console.log(`Header: ${r}`,u),u==="門號"?"phoneNumber":u==="SUBSCR_ID"?"subId":u),complete:u=>{if(u.errors.length>0){alert("Parse Error"),l.value--,c.value++;return}const r=u.data;G(r),l.value--,c.value++}})},G=i=>{v.value+=i.length,i.forEach(u=>{const r=n.subIdUserMap.get(u.subId);r&&(r.phoneNumber=u.phoneNumber,n.phoneNumberUserMap.set(u.phoneNumber,r))}),console.log(`[PhoneNumberFile] read ${i.length} subid <> phone number`)},h=()=>{c.value=0,v.value=0,n.phoneNumberUserMap.clear(),n.refreshFilted()};return(i,u)=>{const r=M,p=Le,g=de;return f(),N("div",Zt,[Wt,C("div",qt,[e(r,{variant:"outline-primary",size:"sm",onClick:S},{default:t(()=>[m("匯入")]),_:1}),v.value>0&&!b.value?(f(),U(r,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:h},{default:t(()=>[e(p)]),_:1})):H("",!0),b.value?(f(),U(g,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),c.value?(f(),N("small",Jt,"已讀取 "+L(c.value)+" 檔案, "+L(v.value)+" 筆記錄",1)):H("",!0)])}}}),Qt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Yt=C("path",{fill:"currentColor",d:"m14 12l-4-4v3H2v2h8v3m10 2V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v3h2V6h12v12H6v-3H4v3a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2"},null,-1),Kt=[Yt];function Xt(V,n){return f(),N("svg",Qt,[...Kt])}const ds={name:"mdi-import",render:Xt},es={class:"title-wrapper"},ts=C("label",{for:"compaign-name"},"活動名稱",-1),ms=Z({__name:"CampaignName",setup(V){const n=W(),l=F("");return Ne(()=>{const c=localStorage.getItem("campaign-name");c&&(l.value=c)}),ae(l,c=>{localStorage.setItem("campaign-name",c),n.campaignName=c}),(c,v)=>{const b=We;return f(),N("div",es,[ts,e(b,{modelValue:l.value,"onUpdate:modelValue":v[0]||(v[0]=S=>l.value=S),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{ds as _,ms as a,cs as b,rs as c,us as d,is as e};
